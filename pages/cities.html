<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="RF åŸé®è³‡è¨Š - æŸ¥çœ‹åŸé®è©³ç´°è³‡æ–™ã€åŠ‡æƒ…æ¨™é¡Œã€é€šé—œçå‹µèˆ‡æ‰è½ç‰©è³‡è¨Š">
    <title>åŸé®è³‡è¨Š - RF æ”»ç•¥ç¶²ç«™</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- å°èˆªæ¬„ -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="../index.html" class="navbar-brand">
                âš”ï¸ RF æ”»ç•¥ç¶²ç«™
            </a>
            <button class="navbar-toggle" onclick="toggleMenu()">â˜°</button>
            <ul class="navbar-menu" id="navMenu">
                <li><a href="../index.html">é¦–é </a></li>
                <li><a href="cities.html" class="active">åŸé®è³‡è¨Š</a></li>
                <li><a href="characters.html">è§’è‰²è³‡è¨Š</a></li>
                <li><a href="calculator.html">æˆ°åŠ›è¨ˆç®—å™¨</a></li>
                <li><a href="guide.html">æ–°æ‰‹æ•™å­¸</a></li>
                <li><a href="query.html">æŸ¥è©¢åŠŸèƒ½</a></li>
                <li><a href="nations.html">åœ‹ç­–è³‡è¨Š</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="content-wrapper">
            <div class="page-header">
                <h1>ğŸ° åŸé®è³‡è¨Š</h1>
                <p>æŸ¥çœ‹åŸé®è©³ç´°è³‡æ–™ã€åŠ‡æƒ…æ¨™é¡Œã€é€šé—œçå‹µèˆ‡æ‰è½ç‰©è³‡è¨Š</p>
            </div>

            <!-- æœå°‹èˆ‡ç¯©é¸ -->
            <div class="card">
                <div class="search-box">
                    <input type="text" id="citySearch" placeholder="æœå°‹åŸé®åç¨±...">
                </div>
                
                <div class="grid grid-4">
                    <div class="form-group">
                        <label class="form-label">é™£ç‡Ÿç¯©é¸</label>
                        <select class="form-control" id="factionFilter">
                            <option value="">å…¨éƒ¨é™£ç‡Ÿ</option>
                            <option value="1">ç´…è»</option>
                            <option value="2">è‡ºç£</option>
                            <option value="3">é¦™æ¸¯</option>
                            <option value="4">è—åœ‹</option>
                            <option value="5">ç¶­å¾çˆ¾</option>
                            <option value="6">å“ˆè–©å…‹</option>
                            <option value="7">æ»¿æ´²</option>
                            <option value="8">è’™å¤</option>
                            <option value="10">åè³Šè¯ç›Ÿ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ’åºæ–¹å¼</label>
                        <select class="form-control" id="sortBy">
                            <option value="id">åŸé® ID</option>
                            <option value="name">åç¨±</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- åŸé®åˆ—è¡¨ -->
            <div id="citiesContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 15px;">è¼‰å…¥åŸé®è³‡æ–™ä¸­...</p>
                </div>
            </div>

            <!-- åŸé®è©³ç´°è³‡è¨Š Modal -->
            <div id="cityModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal()">&times;</span>
                    <div id="cityDetail"></div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>RF æ”»ç•¥ç¶²ç«™ | ä½¿ç”¨ GitHub Pages å»ºç½®</p>
        </footer>
    </div>

    <script src="../js/app.js"></script>
    <script>
        let citiesData = [];
        let rawCitiesData = [];

        // å¾ JSON è¼‰å…¥åŸé®è³‡æ–™
        async function loadCitiesData() {
            try {
                // åŠ å…¥æ™‚é–“æˆ³é¿å…å¿«å–å•é¡Œ
                const timestamp = new Date().getTime();
                const response = await fetch(`../return_data_example/cities.json?t=${timestamp}`);
                const data = await response.json();
                rawCitiesData = data.cities || [];
                
                // è½‰æ›è³‡æ–™æ ¼å¼
                citiesData = rawCitiesData.map(city => ({
                    id: city.id,
                    name: city.name,
                    owner: city.control_nation?.name || 'æœªçŸ¥',
                    ownerId: city.control_nation?.id || 0,
                    chapter: city.chapter ? `${city.chapter.name} ${city.chapter.number}-${city.chapter.serial}` : '-',
                    storyTitle: city.title || '-',
                    description: city.description || '-',
                    pointDescription: city.point_description || null,
                    capital: city.capital,
                    status: city.status,
                    movable: city.movable,
                    sovereign: city.sovereign,
                    controlUnion: city.control_union?.name || null,
                    energyCharge: city.energy_charge,
                    bonus: city.bonus?.percentage || 0,
                    upCityId: city.up_city_id,
                    downCityId: city.down_city_id,
                    leftCityId: city.left_city_id,
                    rightCityId: city.right_city_id,
                    mapBuilding: city.map_building,
                    windowViewImage: city.window_view_image,
                    citySpoils: city.city_spoils || [],
                    reward: city.reward,
                    rewardCollected: city.reward_collected,
                    nationBattle: city.nation_battle,
                    hq: city.hq,
                    hijackable: city.hijackable
                }));
                
                renderCities(citiesData);
            } catch (error) {
                console.error('è¼‰å…¥åŸé®è³‡æ–™å¤±æ•—:', error);
                document.getElementById('citiesContainer').innerHTML = `
                    <div class="alert alert-danger">
                        è¼‰å…¥åŸé®è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèª cities.json æª”æ¡ˆå­˜åœ¨ä¸”æ ¼å¼æ­£ç¢ºã€‚<br>
                        éŒ¯èª¤ï¼š${error.message}
                    </div>
                `;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCitiesData();
            
            // ç¶å®šæœå°‹äº‹ä»¶
            document.getElementById('citySearch').addEventListener('input', debounce(filterCities, 300));
            document.getElementById('factionFilter').addEventListener('change', filterCities);
            document.getElementById('sortBy').addEventListener('change', filterCities);
        });

        // ç¯©é¸åŸé®
        function filterCities() {
            const searchText = document.getElementById('citySearch').value.toLowerCase();
            const faction = document.getElementById('factionFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            
            let filtered = citiesData.filter(city => {
                const matchSearch = city.name.toLowerCase().includes(searchText);
                const matchFaction = !faction || city.ownerId == faction;
                return matchSearch && matchFaction;
            });
            
            // æ’åº
            filtered.sort((a, b) => {
                if (sortBy === 'name') {
                    return a.name.localeCompare(b.name, 'zh-TW');
                }
                return a.id - b.id;
            });
            
            renderCities(filtered);
        }

        // æ¸²æŸ“åŸé®åˆ—è¡¨
        function renderCities(cities) {
            const container = document.getElementById('citiesContainer');
            
            if (cities.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„åŸé®
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <p style="margin-bottom: 15px; color: var(--muted-text);">å…± ${cities.length} å€‹åŸé®</p>
                <div class="grid grid-auto">
                    ${cities.map(city => `
                        <div class="card" onclick="showCityDetail(${city.id})" style="cursor: pointer;">
                            <div class="card-header">
                                <span class="card-title">${city.name}</span>
                                <span class="badge ${getNationClass(city.ownerId)}">${city.owner}</span>
                            </div>
                            <div class="card-body">
                                <p><strong>ç« ç¯€ï¼š</strong>${city.chapter}</p>
                                <p><strong>åŠ‡æƒ…ï¼š</strong>${city.storyTitle}</p>
                                ${city.sovereign ? `<p><strong>ä¸»æ¬Šï¼š</strong>${city.sovereign}</p>` : ''}
                                ${city.capital ? '<span class="badge badge-warning">é¦–éƒ½</span>' : ''}
                                ${city.hq ? '<span class="badge badge-info">ç¸½éƒ¨</span>' : ''}
                                <div style="margin-top: 15px;">
                                    <span class="badge badge-success">ID: ${city.id}</span>
                                    ${city.movable ? '<span class="badge badge-info">å¯é€²å…¥</span>' : '<span class="badge badge-muted">ç„¡æ³•é€²å…¥</span>'}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // é¡¯ç¤ºåŸé®è©³æƒ…
        function showCityDetail(cityId) {
            const city = citiesData.find(c => c.id === cityId);
            if (!city) return;
            
            const modal = document.getElementById('cityModal');
            const detail = document.getElementById('cityDetail');
            
            // æ‰¾å‡ºç›¸é„°åŸé®åç¨±
            const getCityName = (id) => {
                if (!id) return 'ç„¡';
                const found = citiesData.find(c => c.id === id);
                return found ? found.name : `ID: ${id}`;
            };
            
            // æ¸²æŸ“æ‰è½ç‰©å“
            const renderSpoils = (spoils) => {
                if (!spoils || spoils.length === 0) {
                    return '<p style="color: var(--muted-text);">ç„¡æ‰è½ç‰©å“è³‡æ–™</p>';
                }
                
                // åˆ†é›¢å›ºå®šæ‰è½å’Œéš¨æ©Ÿæ‰è½
                const fixedSpoils = spoils.filter(s => !s.random);
                const randomSpoils = spoils.filter(s => s.random);
                const randomCount = randomSpoils.length;
                
                let html = '';
                
                // å›ºå®šæ‰è½
                if (fixedSpoils.length > 0) {
                    html += '<h4 style="margin-bottom: 10px; color: var(--success-color);">ğŸ å›ºå®šçå‹µ</h4>';
                    html += fixedSpoils.map((spoil, idx) => {
                        if (!spoil.items || spoil.items.length === 0) return '';
                        return `
                            <div style="margin-bottom: 15px;">
                                <table class="table">
                                    <thead>
                                        <tr><th>ç‰©å“</th><th>æ•¸é‡</th><th>é¡å‹</th></tr>
                                    </thead>
                                    <tbody>
                                        ${spoil.items.map(item => `
                                            <tr>
                                                <td>
                                                    ${item.image_url ? `<img src="${getAssetPath(item.image_url)}" alt="${item.name}" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 5px;">` : ''}
                                                    ${item.name}
                                                </td>
                                                <td>${item.quantity || '-'}</td>
                                                <td>${item.item_type || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }).join('');
                }
                
                // éš¨æ©Ÿæ‰è½
                if (randomSpoils.length > 0) {
                    // è¨ˆç®— reference ç¸½å’Œ
                    const totalReference = randomSpoils.reduce((sum, s) => sum + (s.reference || 1), 0);
                    
                    html += '<h4 style="margin: 20px 0 10px; color: var(--warning-color);">ğŸ² éš¨æ©Ÿçå‹µ</h4>';
                    html += `<p style="margin-bottom: 10px; color: var(--muted-text); font-size: 0.9em;">å…± ${randomCount} ç¨®å¯èƒ½ï¼Œæ¯æ¬¡é€šé—œéš¨æ©Ÿç²å¾—å…¶ä¸­ä¸€ç¨®</p>`;
                    html += randomSpoils.map((spoil, idx) => {
                        if (!spoil.items || spoil.items.length === 0) return '';
                        // è¨ˆç®—æ©Ÿç‡ï¼šä½¿ç”¨ reference æ¬„ä½åŠ ç¸½è¨ˆç®—çœŸå¯¦æ‰è½æ©Ÿç‡
                        const reference = spoil.reference || 1;
                        const probability = (reference / totalReference) * 100;
                        return `
                            <div style="margin-bottom: 15px; border-left: 3px solid var(--warning-color); padding-left: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: bold;">é¸é … ${idx + 1}</span>
                                    <span class="badge badge-warning">æ©Ÿç‡ï¼š${probability.toFixed(1)}%</span>
                                </div>
                                <table class="table">
                                    <thead>
                                        <tr><th>ç‰©å“</th><th>æ•¸é‡</th><th>é¡å‹</th></tr>
                                    </thead>
                                    <tbody>
                                        ${spoil.items.map(item => `
                                            <tr>
                                                <td>
                                                    ${item.image_url ? `<img src="${getAssetPath(item.image_url)}" alt="${item.name}" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 5px;">` : ''}
                                                    ${item.name}
                                                </td>
                                                <td>${item.quantity || '-'}</td>
                                                <td>${item.item_type || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }).join('');
                }
                
                return html || '<p style="color: var(--muted-text);">ç„¡æ‰è½ç‰©å“è³‡æ–™</p>';
            };
            
            detail.innerHTML = `
                <h2 style="color: var(--primary-color); margin-bottom: 20px;">
                    ğŸ° ${city.name}
                    <span class="badge ${getNationClass(city.ownerId)}" style="margin-left: 10px;">${city.owner}</span>
                    ${city.capital ? '<span class="badge badge-warning" style="margin-left: 5px;">é¦–éƒ½</span>' : ''}
                </h2>
                
                <div class="grid grid-2" style="gap: 25px;">
                    <div>
                        <h3 style="margin-bottom: 15px;">ğŸ“– åŸºæœ¬è³‡è¨Š</h3>
                        <table class="table">
                            <tr><th>åŸé® ID</th><td>${city.id}</td></tr>
                            <tr><th>ç« ç¯€</th><td>${city.chapter}</td></tr>
                            <tr><th>åŠ‡æƒ…æ¨™é¡Œ</th><td>${city.storyTitle}</td></tr>
                            <tr><th>èªªæ˜</th><td>${city.pointDescription || city.description}</td></tr>
                            <tr><th>ä¸»æ¬Š</th><td>${city.sovereign || '-'}</td></tr>
                            <tr><th>æ§åˆ¶è»åœ˜</th><td>${city.controlUnion || '-'}</td></tr>
                            <tr><th>ç‹€æ…‹</th><td>${city.movable ? 'å¯é€²å…¥' : 'ç„¡æ³•é€²å…¥'}</td></tr>
                        </table>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 15px;">ğŸ—ºï¸ åœ°åœ–è³‡è¨Š</h3>
                        <table class="table">
                            <tr><th>ä¸Šæ–¹åŸé®</th><td>${getCityName(city.upCityId)}</td></tr>
                            <tr><th>ä¸‹æ–¹åŸé®</th><td>${getCityName(city.downCityId)}</td></tr>
                            <tr><th>å·¦æ–¹åŸé®</th><td>${getCityName(city.leftCityId)}</td></tr>
                            <tr><th>å³æ–¹åŸé®</th><td>${getCityName(city.rightCityId)}</td></tr>
                            <tr><th>æ¶ˆè€—é«”åŠ›</th><td>${city.energyCharge || '-'}</td></tr>
                            <tr><th>åŠ æˆ</th><td>${city.bonus}%</td></tr>
                            <tr><th>å¯åŠ«æŒ</th><td>${city.hijackable ? 'æ˜¯' : 'å¦'}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div style="margin-top: 25px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“¦ æ‰è½ç‰©å“</h3>
                    ${renderSpoils(city.citySpoils)}
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // é—œé–‰ Modal
        function closeModal() {
            document.getElementById('cityModal').style.display = 'none';
        }

        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        document.getElementById('cityModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>

    <style>
        /* Modal æ¨£å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: var(--muted-text);
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            #cityDetail .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
