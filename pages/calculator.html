<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="RF æˆ°åŠ›è¨ˆç®—å™¨ - è‡ªç”±ç·¨éšŠè¨ˆç®—è§’è‰²èˆ‡éšŠä¼æˆ°åŠ›">
    <title>æˆ°åŠ›è¨ˆç®—å™¨ - RF æ”»ç•¥ç¶²ç«™</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .actor-selection {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            padding: 20px;
            background: var(--light-bg);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .actor-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .actor-input-group label {
            font-weight: bold;
            color: var(--dark-text);
            font-size: 0.9em;
        }

        .scarcity-display {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            min-height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.2em;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .results-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .actor-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid var(--primary-color);
            box-shadow: var(--card-shadow);
        }

        .actor-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .actor-card .level-info {
            font-size: 0.85em;
            color: var(--muted-text);
            margin-bottom: 15px;
        }

        .effects-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .effects-section h4 {
            color: var(--dark-text);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .effect-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            color: var(--muted-text);
        }

        .effect-value {
            font-weight: bold;
            color: var(--success-color);
        }

        .power-result {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 15px;
        }

        .summary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
        }

        .summary h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .summary .total-power {
            font-size: 3em;
            font-weight: bold;
        }

        .btn-add {
            width: 100%;
            margin-top: 15px;
        }

        .btn-calculate {
            width: 100%;
            margin-top: 20px;
            padding: 18px;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .actor-selection {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- å°èˆªæ¬„ -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="../index.html" class="navbar-brand">
                âš”ï¸ RF æ”»ç•¥ç¶²ç«™
            </a>
            <button class="navbar-toggle" onclick="toggleMenu()">â˜°</button>
            <ul class="navbar-menu" id="navMenu">
                <li><a href="../index.html">é¦–é </a></li>
                <li><a href="cities.html">åŸé®è³‡è¨Š</a></li>
                <li><a href="characters.html">è§’è‰²è³‡è¨Š</a></li>
                <li><a href="calculator.html" class="active">æˆ°åŠ›è¨ˆç®—å™¨</a></li>
                <li><a href="guide.html">æ–°æ‰‹æ•™å­¸</a></li>
                <li><a href="query.html">æŸ¥è©¢åŠŸèƒ½</a></li>
                <li><a href="nations.html">åœ‹ç­–è³‡è¨Š</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="content-wrapper">
            <div class="page-header">
                <h1>âš”ï¸ æˆ°åŠ›è¨ˆç®—å™¨</h1>
                <p>è‡ªç”±ç·¨éšŠè¨ˆç®—è§’è‰²èˆ‡éšŠä¼æˆ°åŠ›ï¼Œè¦åŠƒæœ€å¼·é™£å®¹</p>
            </div>

            <!-- ä½¿ç”¨èªªæ˜ -->
            <div class="alert alert-info" style="margin-bottom: 25px;">
                <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong>
                é¸æ“‡è§’è‰²ã€è¨­å®šç­‰ç´šèˆ‡æ­¦å™¨ï¼Œé»æ“Šã€Œè¨ˆç®—æˆ°åŠ›ã€å³å¯æŸ¥çœ‹æ¯å€‹è§’è‰²çš„æˆ°åŠ›ä»¥åŠéšŠä¼ç¸½æˆ°åŠ›ã€‚
                è¢«å‹•æŠ€èƒ½æœƒè‡ªå‹•è¨ˆç®—å°æ•´å€‹éšŠä¼çš„åŠ æˆæ•ˆæœã€‚
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ğŸ® è§’è‰²ç·¨éšŠ</span>
                    <span class="badge badge-primary" id="actorCountBadge">0 å€‹è§’è‰²</span>
                </div>
                <div class="card-body">
                    <div id="actors-container"></div>
                    <button class="btn btn-primary btn-add" onclick="addActorSelection()">
                        â• æ–°å¢è§’è‰²
                    </button>
                    <button class="btn btn-secondary btn-calculate" onclick="calculateAllPowers()">
                        ğŸ”¥ è¨ˆç®—æˆ°åŠ›
                    </button>
                </div>
            </div>

            <!-- çµæœå€åŸŸ -->
            <div id="results" style="margin-top: 30px;"></div>
        </div>

        <footer class="footer">
            <p>RF æ”»ç•¥ç¶²ç«™ | ä½¿ç”¨ GitHub Pages å»ºç½®</p>
        </footer>
    </div>

    <script src="../js/app.js"></script>
    <script>
        let parsedActors = null;
        let actorNames = [];
        let actorCount = 0;

        // è¼‰å…¥è§’è‰²è³‡æ–™
        async function loadActorData() {
            try {
                // åŠ å…¥æ™‚é–“æˆ³é¿å…å¿«å–å•é¡Œ
                const timestamp = new Date().getTime();
                // å˜—è©¦è¼‰å…¥ parsed_actors_skill.jsonï¼ˆåŒ…å«è§£æå¾Œçš„è¢«å‹•æŠ€èƒ½ï¼‰
                let response = await fetch(`../cal_power/parsed_actors_skill.json?t=${timestamp}`);
                if (!response.ok) {
                    // å¦‚æœæ²’æœ‰ï¼Œå˜—è©¦è¼‰å…¥ parsed_actors.json
                    response = await fetch(`../cal_power/parsed_actors.json?t=${timestamp}`);
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                parsedActors = await response.json();
                actorNames = Object.keys(parsedActors).sort((a, b) => a.localeCompare(b, 'zh-TW'));
                console.log(`è¼‰å…¥ ${actorNames.length} å€‹è§’è‰²è³‡æ–™`);

                // è‡ªå‹•æ–°å¢ç¬¬ä¸€å€‹è§’è‰²é¸æ“‡
                addActorSelection();
                updateActorCount();

            } catch (error) {
                console.error('è¼‰å…¥è§’è‰²è³‡æ–™å¤±æ•—:', error);
                document.getElementById('results').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>âš ï¸ ç„¡æ³•è¼‰å…¥è§’è‰²è³‡æ–™</strong><br><br>
                        è«‹ç¢ºèª cal_power è³‡æ–™å¤¾ä¸­å­˜åœ¨è§’è‰²è³‡æ–™æª”æ¡ˆã€‚<br>
                        å¦‚æœæ˜¯é€éæœ¬åœ°é–‹å•Ÿï¼Œè«‹ä½¿ç”¨ HTTP ä¼ºæœå™¨ï¼š<br>
                        <code style="display: block; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            python -m http.server 8000
                        </code>
                    </div>
                `;
            }
        }

        // æ›´æ–°è§’è‰²æ•¸é‡é¡¯ç¤º
        function updateActorCount() {
            const count = document.querySelectorAll('.actor-selection').length;
            document.getElementById('actorCountBadge').textContent = `${count} å€‹è§’è‰²`;
        }

        // æ–°å¢è§’è‰²é¸æ“‡å€å¡Š
        function addActorSelection() {
            if (!parsedActors) {
                alert('è§’è‰²è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆ');
                return;
            }

            const container = document.getElementById('actors-container');
            const id = actorCount++;

            const div = document.createElement('div');
            div.className = 'actor-selection';
            div.id = `actor-${id}`;
            div.innerHTML = `
                <div class="actor-input-group">
                    <label>è§’è‰²åç¨±</label>
                    <select class="form-control" id="actor-select-${id}" onchange="updateActorInfo(${id})">
                        <option value="">-- è«‹é¸æ“‡è§’è‰² --</option>
                        ${actorNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                </div>
                <div class="actor-input-group">
                    <label>ç¨€æœ‰åº¦</label>
                    <div class="scarcity-display" id="scarcity-${id}">-</div>
                </div>
                <div class="actor-input-group">
                    <label>ç­‰ç´š</label>
                    <input type="number" class="form-control" id="level-${id}" min="1" max="300" value="160" placeholder="ç­‰ç´š">
                </div>
                <div class="actor-input-group">
                    <label>æ­¦å™¨</label>
                    <select class="form-control" id="weapon-${id}">
                        <option value="ç„¡ç¬¦æ–‡">ç„¡ç¬¦æ–‡</option>
                        <option value="åŸåˆ" selected>åŸåˆ</option>
                        <option value="å¼·åŒ–">å¼·åŒ–</option>
                        <option value="é«˜ç­‰">é«˜ç­‰</option>
                        <option value="é™å®š">é™å®š</option>
                        <option value="æ’å">æ’å</option>
                        <option value="åºšå­">åºšå­</option>
                        <option value="ä¿å®š">ä¿å®š</option>
                    </select>
                </div>
                <button class="remove-btn" onclick="removeActorSelection(${id})" title="ç§»é™¤è§’è‰²">âœ–</button>
            `;

            container.appendChild(div);
            updateActorCount();
        }

        // ç§»é™¤è§’è‰²é¸æ“‡
        function removeActorSelection(id) {
            const element = document.getElementById(`actor-${id}`);
            if (element) {
                element.remove();
                updateActorCount();
            }
        }

        // æ›´æ–°è§’è‰²è³‡è¨Š
        function updateActorInfo(id) {
            const select = document.getElementById(`actor-select-${id}`);
            const actorName = select.value;
            const scarcityDiv = document.getElementById(`scarcity-${id}`);

            if (actorName && parsedActors[actorName]) {
                const scarcity = parsedActors[actorName].scarcity || 'R';
                scarcityDiv.textContent = scarcity;
                scarcityDiv.className = `scarcity-display scarcity-${scarcity}`;
            } else {
                scarcityDiv.textContent = '-';
                scarcityDiv.className = 'scarcity-display';
            }
        }

        // å– 10 çš„å€æ•¸
        function floorTo10(n) {
            n = parseInt(n || 0);
            return n - (n % 10);
        }

        // è¨ˆç®—è¢«å‹•æŠ€èƒ½æ•ˆæœ
        function calculatePassive(actors) {
            const totalEffects = {
                category: {},
                nation: {}
            };

            // åˆå§‹åŒ–é¡åˆ¥å’Œåœ‹å®¶æ•ˆæœ
            actors.forEach(actor => {
                if (!actor.name || !parsedActors[actor.name]) return;
                const actorData = parsedActors[actor.name];
                if (actorData.actor_category && !totalEffects.category[actorData.actor_category]) {
                    totalEffects.category[actorData.actor_category] = { atk: 0, def: 0, hp: 0 };
                }
                if (actorData.nation && !totalEffects.nation[actorData.nation]) {
                    totalEffects.nation[actorData.nation] = { atk: 0, def: 0, hp: 0 };
                }
            });

            // è¨ˆç®—æ•ˆæœ
            actors.forEach(actor => {
                if (!actor.name || !parsedActors[actor.name]) return;

                const actorData = parsedActors[actor.name];
                const passiveSkills = actorData.parsed_passive_skills;

                if (!passiveSkills) return;

                const activeLevel = floorTo10(actor.level);
                const activeEffect = passiveSkills[String(activeLevel)] || {};

                if (activeEffect.category) {
                    Object.keys(activeEffect.category).forEach(cat => {
                        if (!totalEffects.category[cat]) {
                            totalEffects.category[cat] = { atk: 0, def: 0, hp: 0 };
                        }
                        ['atk', 'def', 'hp'].forEach(stat => {
                            totalEffects.category[cat][stat] += activeEffect.category[cat][stat] || 0;
                        });
                    });
                }

                if (activeEffect.nation) {
                    Object.keys(activeEffect.nation).forEach(nat => {
                        if (!totalEffects.nation[nat]) {
                            totalEffects.nation[nat] = { atk: 0, def: 0, hp: 0 };
                        }
                        ['atk', 'def', 'hp'].forEach(stat => {
                            totalEffects.nation[nat][stat] += activeEffect.nation[nat][stat] || 0;
                        });
                    });
                }
            });

            return totalEffects;
        }

        // è¨ˆç®—å–®ä¸€è§’è‰²æˆ°åŠ›
        function calculatePower(effects, scarcity, level, weapon) {
            const powerMultiplier = {
                'R': 1.0,
                'SR': 1.2,
                'SSR': 1.4
            };

            const weaponMultiplier = {
                'ç„¡ç¬¦æ–‡': 1.0,
                'åŸåˆ': 1.7,
                'å¼·åŒ–': 2.1,
                'é«˜ç­‰': 5.0,
                'é™å®š': 2.5,
                'æ’å': 7.0,
                'åºšå­': 8.0,
                'ä¿å®š': 10.0
            };

            // ç¨€æœ‰åº¦ç­‰ç´šä¸Šé™
            if (scarcity === 'R') level = Math.min(level, 90);
            else if (scarcity === 'SR') level = Math.min(level, 160);
            else if (scarcity === 'SSR') level = Math.min(level, 300);

            const multiplier = powerMultiplier[scarcity] || 1.0;
            const weaponMult = weaponMultiplier[weapon] || 1.0;
            const atkBonus = effects.atk || 0;
            const defBonus = effects.def || 0;
            const hpBonus = effects.hp || 0;

            const totalPower = level * multiplier * weaponMult * (1 + ((1 + (atkBonus / 100 + hpBonus / 100)) * (1 + defBonus / 100) - 1) * 0.2) / 10 + 4;
            return totalPower;
        }

        // è¨ˆç®—æ‰€æœ‰è§’è‰²æˆ°åŠ›
        function calculateAllPowers() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 15px;">è¨ˆç®—ä¸­...</p>
                </div>
            `;

            setTimeout(() => {
                try {
                    // æ”¶é›†æ‰€æœ‰é¸æ“‡çš„è§’è‰²
                    const actors = [];
                    const actorElements = document.querySelectorAll('.actor-selection');

                    actorElements.forEach((element) => {
                        const id = element.id.split('-')[1];
                        const selectElement = document.getElementById(`actor-select-${id}`);
                        const levelElement = document.getElementById(`level-${id}`);
                        const weaponElement = document.getElementById(`weapon-${id}`);

                        const name = selectElement ? selectElement.value.trim() : '';
                        const level = parseInt(levelElement?.value) || 160;
                        const weapon = weaponElement ? weaponElement.value : 'åŸåˆ';

                        if (name && parsedActors[name]) {
                            actors.push({
                                name: name,
                                level: level,
                                weapon: weapon,
                                scarcity: parsedActors[name].scarcity || 'R'
                            });
                        }
                    });

                    if (actors.length === 0) {
                        resultsDiv.innerHTML = `
                            <div class="alert alert-warning">
                                âš ï¸ è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è§’è‰²
                            </div>
                        `;
                        return;
                    }

                    // è¨ˆç®—æ‰€æœ‰è¢«å‹•æ•ˆæœ
                    const totalEffects = calculatePassive(actors);

                    // è¨ˆç®—æ¯å€‹è§’è‰²çš„æˆ°åŠ›
                    let html = '';
                    let totalPowerSum = 0;

                    actors.forEach(actor => {
                        const actorData = parsedActors[actor.name];
                        const selfEffects = { atk: 0, def: 0, hp: 0 };

                        // ç²å–è‡ªèº«è¢«å‹•æ•ˆæœ
                        const passiveSkills = actorData.parsed_passive_skills;
                        const effLevel = floorTo10(actor.level);

                        if (passiveSkills) {
                            const activeEffect = passiveSkills[String(effLevel)] || {};

                            if (activeEffect.self) {
                                ['atk', 'def', 'hp'].forEach(stat => {
                                    selfEffects[stat] += activeEffect.self[stat] || 0;
                                });
                            }
                        }

                        // åŠ ä¸Šé™£ç‡Ÿå’Œåœ‹å®¶æ•ˆæœ
                        const actorCategory = actorData.actor_category || 'æœªçŸ¥';
                        const actorNation = actorData.nation || 'æœªçŸ¥';

                        if (totalEffects.category[actorCategory]) {
                            ['atk', 'def', 'hp'].forEach(stat => {
                                selfEffects[stat] += totalEffects.category[actorCategory][stat] || 0;
                            });
                        }

                        if (totalEffects.nation[actorNation]) {
                            ['atk', 'def', 'hp'].forEach(stat => {
                                selfEffects[stat] += totalEffects.nation[actorNation][stat] || 0;
                            });
                        }

                        // è¨ˆç®—æˆ°åŠ›
                        const power = calculatePower(selfEffects, actor.scarcity, actor.level, actor.weapon);
                        totalPowerSum += power;

                        html += `
                            <div class="actor-card">
                                <h3>
                                    <span>${actor.name}</span>
                                    <span class="badge scarcity-${actor.scarcity}">${actor.scarcity}</span>
                                </h3>
                                <div class="level-info">
                                    ç­‰ç´š: ${actor.level}ï¼ˆç”Ÿæ•ˆ: Lv.${effLevel}ï¼‰| æ­¦å™¨: ${actor.weapon} | 
                                    è·æ¥­: ${actorCategory} | é™£ç‡Ÿ: ${actorNation}
                                </div>
                                
                                <div class="effects-section">
                                    <h4>ğŸ“Š æ•ˆæœåŠ æˆ</h4>
                                    <div class="effect-item">
                                        <span>æ”»æ“ŠåŠ›åŠ æˆ</span>
                                        <span class="effect-value">+${selfEffects.atk.toFixed(1)}%</span>
                                    </div>
                                    <div class="effect-item">
                                        <span>é˜²ç¦¦åŠ›åŠ æˆ</span>
                                        <span class="effect-value">+${selfEffects.def.toFixed(1)}%</span>
                                    </div>
                                    <div class="effect-item">
                                        <span>ç”Ÿå‘½å€¼åŠ æˆ</span>
                                        <span class="effect-value">+${selfEffects.hp.toFixed(1)}%</span>
                                    </div>
                                </div>
                                
                                <div class="power-result">
                                    âš”ï¸ æˆ°åŠ›ï¼š${power.toFixed(2)}
                                </div>
                            </div>
                        `;
                    });

                    // é¡¯ç¤ºç¸½æˆ°åŠ›
                    const summaryHtml = `
                        <div class="summary">
                            <h3>ğŸ† éšŠä¼ç¸½æˆ°åŠ› ğŸ†</h3>
                            <div class="total-power">${totalPowerSum.toFixed(2)}</div>
                            <div style="margin-top: 10px;">å·²é¸æ“‡ ${actors.length} å€‹è§’è‰²</div>
                        </div>
                    `;

                    resultsDiv.innerHTML = summaryHtml + '<div class="results-grid">' + html + '</div>';

                } catch (error) {
                    console.error('è¨ˆç®—éŒ¯èª¤:', error);
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            âŒ è¨ˆç®—éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}
                        </div>
                    `;
                }
            }, 100);
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', loadActorData);
    </script>
</body>

</html>