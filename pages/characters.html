<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="RF è§’è‰²è³‡è¨Š - å®Œæ•´è§’è‰²æ•¸æ“šï¼ŒåŒ…å«è·æ¥­ã€é™£ç‡Ÿã€å¤©è³¦è¡¨ã€ç¬¦æ–‡é¡å‹ã€ç­‰ç´šæ•¸å€¼">
    <title>è§’è‰²è³‡è¨Š - RF æ”»ç•¥ç¶²ç«™</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- å°èˆªæ¬„ -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="../index.html" class="navbar-brand">
                âš”ï¸ RF æ”»ç•¥ç¶²ç«™
            </a>
            <button class="navbar-toggle" onclick="toggleMenu()">â˜°</button>
            <ul class="navbar-menu" id="navMenu">
                <li><a href="../index.html">é¦–é </a></li>
                <li><a href="cities.html">åŸé®è³‡è¨Š</a></li>
                <li><a href="characters.html" class="active">è§’è‰²è³‡è¨Š</a></li>
                <li><a href="calculator.html">æˆ°åŠ›è¨ˆç®—å™¨</a></li>
                <li><a href="guide.html">æ–°æ‰‹æ•™å­¸</a></li>
                <li><a href="query.html">æŸ¥è©¢åŠŸèƒ½</a></li>
                <li><a href="nations.html">åœ‹ç­–è³‡è¨Š</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="content-wrapper">
            <div class="page-header">
                <h1>ğŸ‘¤ è§’è‰²è³‡è¨Š</h1>
                <p>å®Œæ•´è§’è‰²æ•¸æ“šï¼ŒåŒ…å«è·æ¥­ã€é™£ç‡Ÿã€å¤©è³¦è¡¨ã€ç¬¦æ–‡é¡å‹ã€ç­‰ç´šæ•¸å€¼</p>
            </div>

            <!-- æœå°‹èˆ‡ç¯©é¸ -->
            <div class="card">
                <div class="search-box">
                    <input type="text" id="characterSearch" placeholder="æœå°‹è§’è‰²åç¨±...">
                </div>
                
                <div class="grid grid-4">
                    <div class="form-group">
                        <label class="form-label">ç¨€æœ‰åº¦</label>
                        <select class="form-control" id="scarcityFilter">
                            <option value="">å…¨éƒ¨ç¨€æœ‰åº¦</option>
                            <option value="R">R</option>
                            <option value="SR">SR</option>
                            <option value="SSR">SSR</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è·æ¥­</label>
                        <select class="form-control" id="roleFilter">
                            <option value="">å…¨éƒ¨è·æ¥­</option>
                            <option value="agitator">å®£å‚³å®¶</option>
                            <option value="sponsor">è³‡åŠ©è€…</option>
                            <option value="spy">é–“è«œ</option>
                            <option value="guerrilla">æ¸¸æ“ŠéšŠ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é™£ç‡Ÿ</label>
                        <select class="form-control" id="nationFilter">
                            <option value="">å…¨éƒ¨é™£ç‡Ÿ</option>
                            <option value="1">ç´…è»</option>
                            <option value="2">è‡ºç£</option>
                            <option value="3">é¦™æ¸¯</option>
                            <option value="4">è—åœ‹</option>
                            <option value="5">ç¶­å¾çˆ¾</option>
                            <option value="6">å“ˆè–©å…‹</option>
                            <option value="7">æ»¿æ´²</option>
                            <option value="8">è’™å¤</option>
                            <option value="10">åè³Šè¯ç›Ÿ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ’åº</label>
                        <select class="form-control" id="sortFilter">
                            <option value="name">åç¨±</option>
                            <option value="scarcity">ç¨€æœ‰åº¦</option>
                            <option value="maxLevel">æœ€å¤§ç­‰ç´š</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div class="grid grid-4" style="margin-bottom: 25px;">
                <div class="stat-box" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: #333;">
                    <div class="stat-value" id="rCount">-</div>
                    <div class="stat-label">R è§’è‰²</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333;">
                    <div class="stat-value" id="srCount">-</div>
                    <div class="stat-label">SR è§’è‰²</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);">
                    <div class="stat-value" id="ssrCount">-</div>
                    <div class="stat-label">SSR è§’è‰²</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalCount">-</div>
                    <div class="stat-label">ç¸½è¨ˆ</div>
                </div>
            </div>

            <!-- è§’è‰²åˆ—è¡¨ -->
            <div id="charactersContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 15px;">è¼‰å…¥è§’è‰²è³‡æ–™ä¸­...</p>
                </div>
            </div>

            <!-- è§’è‰²è©³æƒ… Modal -->
            <div id="characterModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeCharacterModal()">&times;</span>
                    <div id="characterDetail"></div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>RF æ”»ç•¥ç¶²ç«™ | ä½¿ç”¨ GitHub Pages å»ºç½®</p>
        </footer>
    </div>

    <script src="../js/app.js"></script>
    <script>
        let charactersData = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // è¼‰å…¥è§’è‰²è³‡æ–™ (ä½¿ç”¨ unique_actors.json å–å¾—å®Œæ•´è³‡æ–™)
                // åŠ å…¥æ™‚é–“æˆ³é¿å…å¿«å–å•é¡Œ
                const timestamp = new Date().getTime();
                const response = await fetch(`../cal_power/unique_actors.json?t=${timestamp}`);
                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');
                const data = await response.json();
                
                // è½‰æ›è³‡æ–™æ ¼å¼ - ä½¿ç”¨å¯¦éš› JSON è³‡æ–™
                charactersData = data.map((actor, index) => ({
                    id: index + 1,
                    name: actor.actor_prototype?.name || 'æœªçŸ¥',
                    scarcity: actor.scarcity || 'R',
                    role: actor.actor_prototype?.actor_category?.name || 'æœªçŸ¥',
                    nation: actor.nation_id || 0,
                    baseATK: actor.actor_prototype?.offense_base_value || 0,
                    atkPerLevel: actor.actor_prototype?.offense_elevation_value || 0,
                    baseHP: actor.actor_prototype?.blood_base_value || 0,
                    hpPerLevel: actor.actor_prototype?.blood_elevation_value || 0,
                    maxLevel: actor.level_cap || getMaxLevel(actor),
                    runeType: actor.no_weapon_name || 'æœªçŸ¥',
                    passiveSkills: actor.passive_skills || [],
                    biography: actor.actor_prototype?.description || `${actor.actor_prototype?.name || 'æœªçŸ¥'}çš„æ•…äº‹...`,
                    headImage: actor.head_image || '',
                    halfImage: actor.half_image || '',
                    gifImage: actor.gif_image || '',
                    activeSkill: actor.active_skill || null,
                    talent1: actor.actor_prototype?.talent_1 || '',
                    talent2: actor.actor_prototype?.talent_2 || ''
                }));
                
                // æ›´æ–°çµ±è¨ˆ
                updateStats();
                
                // æ¸²æŸ“è§’è‰²
                filterCharacters();
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                document.getElementById('charactersContainer').innerHTML = `
                    <div class="alert alert-danger">
                        è¼‰å…¥è§’è‰²è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèª cal_power/unique_actors.json æª”æ¡ˆå­˜åœ¨
                    </div>
                `;
            }
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('characterSearch').addEventListener('input', debounce(filterCharacters, 300));
            document.getElementById('scarcityFilter').addEventListener('change', filterCharacters);
            document.getElementById('roleFilter').addEventListener('change', filterCharacters);
            document.getElementById('nationFilter').addEventListener('change', filterCharacters);
            document.getElementById('sortFilter').addEventListener('change', filterCharacters);
        });

        function getMaxLevel(actorData) {
            if (!actorData?.passive_skills?.length) return 100;
            const levels = actorData.passive_skills.map(s => s.level);
            return Math.max(...levels);
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            const rCount = charactersData.filter(c => c.scarcity === 'R').length;
            const srCount = charactersData.filter(c => c.scarcity === 'SR').length;
            const ssrCount = charactersData.filter(c => c.scarcity === 'SSR').length;
            
            document.getElementById('rCount').textContent = rCount;
            document.getElementById('srCount').textContent = srCount;
            document.getElementById('ssrCount').textContent = ssrCount;
            document.getElementById('totalCount').textContent = charactersData.length;
        }

        // ç¯©é¸è§’è‰²
        function filterCharacters() {
            const search = document.getElementById('characterSearch').value.toLowerCase();
            const scarcity = document.getElementById('scarcityFilter').value;
            const role = document.getElementById('roleFilter').value;
            const nation = document.getElementById('nationFilter').value;
            const sortBy = document.getElementById('sortFilter').value;
            
            let filtered = charactersData.filter(char => {
                const matchSearch = char.name.toLowerCase().includes(search);
                const matchScarcity = !scarcity || char.scarcity === scarcity;
                const matchRole = !role || char.role === role;
                const matchNation = !nation || char.nation == nation;
                return matchSearch && matchScarcity && matchRole && matchNation;
            });
            
            // æ’åº
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'scarcity':
                        const order = { 'SSR': 0, 'SR': 1, 'R': 2 };
                        return order[a.scarcity] - order[b.scarcity];
                    case 'maxLevel':
                        return b.maxLevel - a.maxLevel;
                    default:
                        return a.name.localeCompare(b.name, 'zh-TW');
                }
            });
            
            renderCharacters(filtered);
        }

        // æ¸²æŸ“è§’è‰²åˆ—è¡¨
        function renderCharacters(characters) {
            const container = document.getElementById('charactersContainer');
            
            if (characters.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è§’è‰²
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="grid grid-auto">
                    ${characters.map(char => `
                        <div class="card character-card" onclick="showCharacterDetail('${char.name}')" style="cursor: pointer;">
                            <div class="card-header" style="display: flex; align-items: center; gap: 10px;">
                                ${char.headImage ? `<img src="https://www.rf.newroadfound.com${char.headImage}" alt="${char.name}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'">` : ''}
                                <span class="card-title">${char.name}</span>
                                <span class="badge ${getScarcityClass(char.scarcity)}" style="margin-left: auto;">${char.scarcity}</span>
                            </div>
                            <div class="card-body">
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                                    <span class="badge badge-primary">${getRoleName(char.role)}</span>
                                    <span class="badge ${getNationClass(char.nation)}">${getNationName(char.nation)}</span>
                                </div>
                                <p><strong>æœ€å¤§ç­‰ç´šï¼š</strong>${char.maxLevel}</p>
                                <p><strong>ç¬¦æ–‡é¡å‹ï¼š</strong>${char.runeType}</p>
                                <p><strong>åŸºç¤ATKï¼š</strong>${char.baseATK.toLocaleString()} (+${char.atkPerLevel}/ç­‰)</p>
                                <p><strong>åŸºç¤HPï¼š</strong>${char.baseHP.toLocaleString()} (+${char.hpPerLevel}/ç­‰)</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // é¡¯ç¤ºè§’è‰²è©³æƒ…
        function showCharacterDetail(charName) {
            const char = charactersData.find(c => c.name === charName);
            if (!char) return;
            
            const modal = document.getElementById('characterModal');
            const detail = document.getElementById('characterDetail');
            
            // æº–å‚™å¤©è³¦è¡¨æ ¼
            let skillsTable = '';
            if (char.passiveSkills && char.passiveSkills.length > 0) {
                skillsTable = `
                    <div style="margin-top: 25px;">
                        <h3 style="margin-bottom: 15px;">ğŸ“Š å¤©è³¦è¡¨</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr><th>ç­‰ç´š</th><th>è¢«å‹•æŠ€èƒ½æ•ˆæœ</th></tr>
                                </thead>
                                <tbody>
                                    ${char.passiveSkills.map(skill => `
                                        <tr>
                                            <td><strong>Lv.${skill.level}</strong></td>
                                            <td>${skill.description}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // ç­‰ç´šæ•¸å€¼è¨ˆç®—å™¨
            const levelSlider = `
                <div style="margin-top: 25px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“ˆ ç­‰ç´šæ•¸å€¼è¨ˆç®—</h3>
                    <div class="form-group">
                        <label class="form-label">è¼¸å…¥ç­‰ç´š (1 - ${char.maxLevel})ï¼š</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="levelInput" min="1" max="${char.maxLevel}" value="1" 
                                   class="form-control" style="width: 100px; text-align: center;"
                                   oninput="updateCharStats(${char.baseATK}, ${char.atkPerLevel}, ${char.baseHP}, ${char.hpPerLevel}, ${char.maxLevel})">
                            <input type="range" id="levelSlider" min="1" max="${char.maxLevel}" value="1" 
                                   style="flex: 1;" oninput="syncLevelInput(this.value); updateCharStats(${char.baseATK}, ${char.atkPerLevel}, ${char.baseHP}, ${char.hpPerLevel}, ${char.maxLevel})">
                        </div>
                    </div>
                    <div class="grid grid-2" style="gap: 15px;">
                        <div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="stat-value" id="calcATK">${char.baseATK.toLocaleString()}</div>
                            <div class="stat-label">æ”»æ“ŠåŠ› (ATK)</div>
                        </div>
                        <div class="stat-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="stat-value" id="calcHP">${char.baseHP.toLocaleString()}</div>
                            <div class="stat-label">ç”Ÿå‘½å€¼ (HP)</div>
                        </div>
                    </div>
                </div>
            `;
            
            detail.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 25px;">
                    ${char.halfImage || char.gifImage ? 
                        `<img src="https://www.rf.newroadfound.com${char.halfImage || char.gifImage}" alt="${char.name}" style="width: 120px; height: auto; border-radius: 10px; object-fit: contain;" onerror="this.outerHTML='<div style=\\'width: 100px; height: 100px; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5em;\\'>${char.name.charAt(0)}</div>'">` 
                        : `<div style="width: 100px; height: 100px; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5em;">${char.name.charAt(0)}</div>`
                    }
                    <div>
                        <h2 style="color: var(--primary-color); margin-bottom: 5px;">${char.name}</h2>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                            <span class="badge ${getScarcityClass(char.scarcity)}">${char.scarcity}</span>
                            <span class="badge badge-primary">${getRoleName(char.role)}</span>
                            <span class="badge ${getNationClass(char.nation)}">${getNationName(char.nation)}</span>
                        </div>
                        ${char.talent1 ? `<p style="margin: 5px 0; font-style: italic; color: var(--muted-text);">${char.talent1}</p>` : ''}
                        ${char.talent2 ? `<p style="margin: 5px 0; font-weight: bold; color: var(--primary-color);">${char.talent2}</p>` : ''}
                    </div>
                </div>
                
                <div class="grid grid-2" style="gap: 25px;">
                    <div>
                        <h3 style="margin-bottom: 15px;">ğŸ“‹ åŸºæœ¬è³‡æ–™</h3>
                        <table class="table">
                            <tr><th>è§’è‰²åç¨±</th><td>${char.name}</td></tr>
                            <tr><th>ç¨€æœ‰åº¦</th><td>${char.scarcity}</td></tr>
                            <tr><th>è·æ¥­</th><td>${getRoleName(char.role)}</td></tr>
                            <tr><th>é™£ç‡Ÿ</th><td>${getNationName(char.nation)}</td></tr>
                            <tr><th>æœ€å¤§ç­‰ç´š</th><td>${char.maxLevel}</td></tr>
                            <tr><th>ç¬¦æ–‡é¡å‹</th><td>${char.runeType}</td></tr>
                        </table>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 15px;">ğŸ“– ç”Ÿå¹³</h3>
                        <div class="card" style="margin: 0;">
                            <div class="card-body">
                                <p>${char.biography}</p>
                            </div>
                        </div>
                        
                        <h3 style="margin: 20px 0 15px;">âš”ï¸ åŸºç¤æ•¸å€¼</h3>
                        <table class="table">
                            <tr><th>åŸºç¤ ATK</th><td>${char.baseATK.toLocaleString()}</td></tr>
                            <tr><th>æ¯ç­‰ ATK</th><td>+${char.atkPerLevel.toLocaleString()}</td></tr>
                            <tr><th>åŸºç¤ HP</th><td>${char.baseHP.toLocaleString()}</td></tr>
                            <tr><th>æ¯ç­‰ HP</th><td>+${char.hpPerLevel.toLocaleString()}</td></tr>
                        </table>
                    </div>
                </div>
                
                ${levelSlider}
                ${skillsTable}
            `;
            
            modal.style.display = 'flex';
        }

        // åŒæ­¥ç­‰ç´šè¼¸å…¥æ¡†èˆ‡æ»‘æ¡¿
        function syncLevelInput(value) {
            document.getElementById('levelInput').value = value;
        }
        
        function syncLevelSlider(value) {
            document.getElementById('levelSlider').value = value;
        }

        // æ›´æ–°ç­‰ç´šæ•¸å€¼
        function updateCharStats(baseATK, atkPerLevel, baseHP, hpPerLevel, maxLevel) {
            const input = document.getElementById('levelInput');
            let level = parseInt(input.value) || 1;
            
            // é™åˆ¶ç¯„åœ
            if (level < 1) level = 1;
            if (level > maxLevel) level = maxLevel;
            
            // åŒæ­¥æ»‘æ¡¿
            syncLevelSlider(level);
            input.value = level;
            
            document.getElementById('calcATK').textContent = (baseATK + (level - 1) * atkPerLevel).toLocaleString();
            document.getElementById('calcHP').textContent = (baseHP + (level - 1) * hpPerLevel).toLocaleString();
        }

        // é—œé–‰ Modal
        function closeCharacterModal() {
            document.getElementById('characterModal').style.display = 'none';
        }

        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        document.getElementById('characterModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeCharacterModal();
            }
        });
    </script>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 1000px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: var(--muted-text);
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .character-card:hover {
            border-left: 5px solid var(--primary-color);
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            #characterDetail .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
