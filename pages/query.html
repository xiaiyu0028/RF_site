<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="RF æŸ¥è©¢åŠŸèƒ½ - æŸ¥è©¢å·²æ“æœ‰è§’è‰²ã€åº«å­˜é“å…·ã€ç¬¦æ–‡è£å‚™èˆ‡æŠ½çæ­·å²">
    <title>æŸ¥è©¢åŠŸèƒ½ - RF æ”»ç•¥ç¶²ç«™</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- å°èˆªæ¬„ -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="../index.html" class="navbar-brand">
                âš”ï¸ RF æ”»ç•¥ç¶²ç«™
            </a>
            <button class="navbar-toggle" onclick="toggleMenu()">â˜°</button>
            <ul class="navbar-menu" id="navMenu">
                <li><a href="../index.html">é¦–é </a></li>
                <li><a href="cities.html">åŸé®è³‡è¨Š</a></li>
                <li><a href="characters.html">è§’è‰²è³‡è¨Š</a></li>
                <li><a href="calculator.html">æˆ°åŠ›è¨ˆç®—å™¨</a></li>
                <li><a href="guide.html">æ–°æ‰‹æ•™å­¸</a></li>
                <li><a href="query.html" class="active">æŸ¥è©¢åŠŸèƒ½</a></li>
                <li><a href="nations.html">åœ‹ç­–è³‡è¨Š</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="content-wrapper">
            <div class="page-header">
                <h1>ğŸ” æŸ¥è©¢åŠŸèƒ½</h1>
                <p>æŸ¥è©¢å·²æ“æœ‰è§’è‰²ã€åº«å­˜é“å…·ã€ç¬¦æ–‡è£å‚™èˆ‡æŠ½çæ­·å²</p>
            </div>

            <!-- ç™»å…¥å€å¡Š -->
            <div class="card" id="loginSection">
                <div class="card-header">
                    <span class="card-title">ğŸ” å¸³è™Ÿç™»å…¥</span>
                </div>
                <div class="card-body">
                    <!-- é¢¨éšªè­¦å‘Š -->
                    <div class="alert alert-danger" style="margin-bottom: 20px;">
                        <strong>âš ï¸ é‡è¦å®‰å…¨è­¦å‘Šï¼š</strong>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>æœ¬åŠŸèƒ½éœ€è¦æ‚¨è¼¸å…¥éŠæˆ²å¸³è™Ÿå¯†ç¢¼ï¼Œå­˜åœ¨ä»¥ä¸‹é¢¨éšªï¼š</li>
                            <li><strong>å¸³è™Ÿå®‰å…¨é¢¨éšªï¼š</strong>åœ¨ç¬¬ä¸‰æ–¹ç¶²ç«™è¼¸å…¥å¯†ç¢¼å¯èƒ½å°è‡´å¸³è™Ÿè¢«ç›œ</li>
                            <li><strong>éš±ç§é¢¨éšªï¼š</strong>æ‚¨çš„éŠæˆ²è³‡æ–™å°‡åœ¨ç€è¦½å™¨ä¸­è™•ç†</li>
                            <li><strong>ToS é¢¨éšªï¼š</strong>ä½¿ç”¨éå®˜æ–¹å·¥å…·å¯èƒ½é•åéŠæˆ²æœå‹™æ¢æ¬¾</li>
                            <li>æœ¬ç¶²ç«™<strong>ä¸æœƒå„²å­˜</strong>æ‚¨çš„å¯†ç¢¼ï¼Œä½†è«‹è‡ªè¡Œè©•ä¼°é¢¨éšª</li>
                            <li>å¦‚æœ‰ç–‘æ…®ï¼Œè«‹ä½¿ç”¨ã€Œç¤ºç¯„æ¨¡å¼ã€æŸ¥çœ‹ç¯„ä¾‹è³‡æ–™</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-info" style="margin-bottom: 20px;">
                        <strong>ğŸ“Œ æŠ€è¡“èªªæ˜ï¼š</strong>
                        ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ (CORS)ï¼Œç›´æ¥å¾ç¶²é é€£æ¥éŠæˆ²ä¼ºæœå™¨å¯èƒ½æœƒå¤±æ•—ã€‚
                        å¦‚æœé€£æ¥å¤±æ•—ï¼Œæ‚¨å¯ä»¥ï¼š
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>ä½¿ç”¨ã€Œç¤ºç¯„æ¨¡å¼ã€æŸ¥çœ‹åŠŸèƒ½å±•ç¤º</li>
                            <li>é€éç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ç›´æ¥æ¸¬è©¦ API</li>
                            <li>ä½¿ç”¨æœ¬åœ°ä»£ç†ä¼ºæœå™¨ç¹é CORS é™åˆ¶</li>
                        </ul>
                    </div>
                    
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label">å¸³è™Ÿ (Email)</label>
                            <input type="email" class="form-control" id="accountEmail" placeholder="è¼¸å…¥éŠæˆ²å¸³è™Ÿ Email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¯†ç¢¼</label>
                            <input type="password" class="form-control" id="accountPassword" placeholder="è¼¸å…¥å¯†ç¢¼">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="riskAcknowledge" style="margin-right: 8px;">
                            æˆ‘å·²é–±è®€ä¸¦äº†è§£ä¸Šè¿°é¢¨éšªï¼ŒåŒæ„ç¹¼çºŒ
                        </label>
                    </div>
                    
                    <div class="grid grid-2" style="gap: 15px;">
                        <button class="btn btn-primary" onclick="loginAndQuery()" id="loginBtn" disabled>
                            ğŸ”“ ç™»å…¥ä¸¦æŸ¥è©¢
                        </button>
                        <button class="btn btn-outline" onclick="useDemoMode()">
                            ğŸ“‹ ä½¿ç”¨ç¤ºç¯„æ¨¡å¼
                        </button>
                    </div>
                </div>
            </div>

            <!-- åˆ†é å€å¡Š -->
            <div class="tabs-container" id="queryTabs" style="display: none; margin-top: 25px;">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="characters-tab">ğŸ‘¤ è§’è‰²æŸ¥è©¢</button>
                    <button class="tab-btn" data-tab="inventory-tab">ğŸ“¦ åº«å­˜æŸ¥è©¢</button>
                    <button class="tab-btn" data-tab="runes-tab">ğŸ’ ç¬¦æ–‡æŸ¥è©¢</button>
                    <button class="tab-btn" data-tab="gacha-tab">ğŸ° æŠ½çæ­·å²</button>
                </div>

                <!-- è§’è‰²æŸ¥è©¢ -->
                <div class="tab-content active" id="characters-tab">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">ğŸ‘¤ å·²æ“æœ‰è§’è‰²</span>
                            <span class="badge badge-primary" id="ownedCount">0 å€‹è§’è‰²</span>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <input type="text" id="ownedSearch" placeholder="æœå°‹è§’è‰²åç¨±...">
                            </div>
                            <div id="ownedCharacters">
                                <div class="alert alert-info">è«‹å…ˆé©—è­‰ä»¥æŸ¥çœ‹æ‚¨çš„è§’è‰²</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åº«å­˜æŸ¥è©¢ -->
                <div class="tab-content" id="inventory-tab">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">ğŸ“¦ åº«å­˜é“å…·</span>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <input type="text" id="inventorySearch" placeholder="æœå°‹é“å…·åç¨±...">
                            </div>
                            
                            <!-- åˆ†é¡ç¯©é¸ -->
                            <div class="grid grid-4" style="margin-bottom: 20px;">
                                <button class="btn btn-outline" onclick="filterInventory('all')">å…¨éƒ¨</button>
                                <button class="btn btn-outline" onclick="filterInventory('material')">ææ–™</button>
                                <button class="btn btn-outline" onclick="filterInventory('consumable')">æ¶ˆè€—å“</button>
                                <button class="btn btn-outline" onclick="filterInventory('other')">å…¶ä»–</button>
                            </div>
                            
                            <div id="inventoryList">
                                <div class="alert alert-info">è«‹å…ˆé©—è­‰ä»¥æŸ¥çœ‹æ‚¨çš„åº«å­˜</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¬¦æ–‡æŸ¥è©¢ -->
                <div class="tab-content" id="runes-tab">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">ğŸ’ ç¬¦æ–‡è£å‚™</span>
                        </div>
                        <div class="card-body">
                            <div id="runesList">
                                <div class="alert alert-info">è«‹å…ˆé©—è­‰ä»¥æŸ¥çœ‹æ‚¨çš„ç¬¦æ–‡</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æŠ½çæ­·å² -->
                <div class="tab-content" id="gacha-tab">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">ğŸ° æŠ½çæ­·å²è¨˜éŒ„</span>
                        </div>
                        <div class="card-body">
                            <!-- çµ±è¨ˆè³‡æ–™ -->
                            <div class="grid grid-4" style="margin-bottom: 25px;">
                                <div class="stat-box" style="background: linear-gradient(135deg, #84fab0, #8fd3f4); color: #333;">
                                    <div class="stat-value" id="totalGacha">0</div>
                                    <div class="stat-label">ç¸½æŠ½æ•¸</div>
                                </div>
                                <div class="stat-box" style="background: linear-gradient(135deg, #84fab0, #8fd3f4); color: #333;">
                                    <div class="stat-value" id="rRate">0%</div>
                                    <div class="stat-label">R æ©Ÿç‡</div>
                                </div>
                                <div class="stat-box" style="background: linear-gradient(135deg, #a8edea, #fed6e3); color: #333;">
                                    <div class="stat-value" id="srRate">0%</div>
                                    <div class="stat-label">SR æ©Ÿç‡</div>
                                </div>
                                <div class="stat-box" style="background: linear-gradient(135deg, #ffd89b, #19547b);">
                                    <div class="stat-value" id="ssrRate">0%</div>
                                    <div class="stat-label">SSR æ©Ÿç‡</div>
                                </div>
                            </div>
                            
                            <div id="gachaHistory">
                                <div class="alert alert-info">è«‹å…ˆé©—è­‰ä»¥æŸ¥çœ‹æ‚¨çš„æŠ½çæ­·å²</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <footer class="footer">
            <p>RF æ”»ç•¥ç¶²ç«™ | ä½¿ç”¨ GitHub Pages å»ºç½®</p>
        </footer>
    </div>

    <script src="../js/app.js"></script>
    <script>
        // API è¨­å®šï¼ˆåƒè€ƒ get_union.pyï¼‰
        const API_CONFIG = {
            apiBase: 'https://api.komisureiya.com/api',
            wsBase: 'wss://api.komisureiya.com/socket/websocket',
            timeout: 30000,
            appVersion: '2.28',
            key: 'rfront2023'
        };

        // ç‹€æ…‹
        let currentPlayerId = null;
        let wsConnection = null;
        let isDemoMode = false;
        
        // æŸ¥è©¢çµæœå­˜æ”¾
        let ownedActors = [];
        let inventoryItems = [];
        let runesData = [];
        let gachaHistory = [];

        // ç¯„ä¾‹è³‡æ–™ï¼ˆç¤ºç¯„æ¨¡å¼ä½¿ç”¨ï¼‰
        const sampleOwnedCharacters = [
            { name: "å¡å§†è˜­", level: 160, scarcity: "SSR", role: "spy", equipped: "é«˜ç­‰ç¬¦æ–‡" },
            { name: "èŒƒæœ‹å…‹", level: 120, scarcity: "SR", role: "agitator", equipped: "å¼·åŒ–ç¬¦æ–‡" },
            { name: "é™³ç‚¯æ˜", level: 90, scarcity: "R", role: "sponsor", equipped: "åŸåˆç¬¦æ–‡" },
            { name: "é˜¿æ—º", level: 180, scarcity: "SSR", role: "guerrilla", equipped: "åºšå­ç¬¦æ–‡" },
            { name: "å¾·æ¾¤", level: 100, scarcity: "SR", role: "spy", equipped: "é™å®šç¬¦æ–‡" },
        ];

        const sampleInventory = [
            { name: "é‡‘å¹£", count: 158742, category: "material" },
            { name: "æŠ½çåˆ¸", count: 25, category: "consumable" },
            { name: "ç¶“é©—è—¥æ°´", count: 150, category: "consumable" },
            { name: "é›é€ çŸ³", count: 89, category: "material" },
            { name: "è§’è‰²ç¢ç‰‡", count: 340, category: "material" },
            { name: "å¼·åŒ–çŸ³", count: 45, category: "material" },
            { name: "ç¬¦æ–‡ç¢ç‰‡", count: 200, category: "material" },
        ];

        const sampleRunes = [
            { name: "åºšå­æ­¦å™¨", level: 10, owner: "é˜¿æ—º", stats: "ATK+50%, HP+30%" },
            { name: "é«˜ç­‰æ­¦å™¨", level: 8, owner: "å¡å§†è˜­", stats: "ATK+35%, DEF+20%" },
            { name: "æ’åæ­¦å™¨", level: 5, owner: "æœªè£å‚™", stats: "ATK+45%, HP+25%" },
            { name: "é™å®šæ­¦å™¨", level: 6, owner: "å¾·æ¾¤", stats: "ATK+25%, DEF+15%" },
        ];

        const sampleGachaHistory = [
            { date: "2026-02-13", result: "å¡å§†è˜­", scarcity: "SSR", pool: "é™å®šæ± " },
            { date: "2026-02-12", result: "èŒƒæœ‹å…‹", scarcity: "SR", pool: "å¸¸é§æ± " },
            { date: "2026-02-12", result: "é™³ç‚¯æ˜", scarcity: "R", pool: "å¸¸é§æ± " },
            { date: "2026-02-11", result: "å¾·æ¾¤", scarcity: "SR", pool: "å¸¸é§æ± " },
            { date: "2026-02-11", result: "æçƒˆéˆ", scarcity: "R", pool: "å¸¸é§æ± " },
            { date: "2026-02-10", result: "é˜¿æ—º", scarcity: "SSR", pool: "é™å®šæ± " },
        ];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç¶å®šé¢¨éšªç¢ºèªå‹¾é¸æ¡†
            document.getElementById('riskAcknowledge').addEventListener('change', function() {
                document.getElementById('loginBtn').disabled = !this.checked;
            });
        });

        // ä½¿ç”¨ç¤ºç¯„æ¨¡å¼
        function useDemoMode() {
            isDemoMode = true;
            currentPlayerId = 'demo_user';
            
            showLoggedInState('ç¤ºç¯„æ¨¡å¼', true);
            
            // è¼‰å…¥ç¯„ä¾‹è³‡æ–™
            loadOwnedCharacters(sampleOwnedCharacters);
            loadInventory(sampleInventory);
            loadRunes(sampleRunes);
            loadGachaHistory(sampleGachaHistory);
            
            // åˆå§‹åŒ–åˆ†é 
            initTabs();
        }

        // çœŸå¯¦ç™»å…¥æŸ¥è©¢
        async function loginAndQuery() {
            const email = document.getElementById('accountEmail').value.trim();
            const password = document.getElementById('accountPassword').value;
            
            if (!email || !password) {
                alert('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');
                return;
            }
            
            if (!document.getElementById('riskAcknowledge').checked) {
                alert('è«‹å…ˆå‹¾é¸é¢¨éšªç¢ºèª');
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            showLoadingState('æ­£åœ¨é€£æ¥ä¼ºæœå™¨...');
            
            try {
                // å˜—è©¦é€é WebSocket é€£æ¥
                const loginResult = await attemptLogin(email, password);
                
                if (loginResult.success) {
                    currentPlayerId = loginResult.playerId;
                    showLoggedInState(`ç©å®¶ ID: ${currentPlayerId}`, false);
                    
                    // æŸ¥è©¢å„é …è³‡æ–™
                    await fetchAllData();
                    
                    // åˆå§‹åŒ–åˆ†é 
                    initTabs();
                } else {
                    throw new Error(loginResult.error || 'ç™»å…¥å¤±æ•—');
                }
            } catch (error) {
                console.error('API é€£æ¥éŒ¯èª¤:', error);
                
                // é¡¯ç¤ºéŒ¯èª¤ä¸¦æä¾›é¸é …
                document.getElementById('loginSection').innerHTML = `
                    <div class="card-header">
                        <span class="card-title">âŒ é€£æ¥å¤±æ•—</span>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <strong>éŒ¯èª¤ï¼š</strong>${error.message}
                            <br><br>
                            å¯èƒ½åŸå› ï¼š
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>ç€è¦½å™¨ CORS å®‰å…¨é™åˆ¶é˜»æ“‹äº†é€£æ¥</li>
                                <li>éŠæˆ²ä¼ºæœå™¨æš«æ™‚ç„¡æ³•é€£æ¥</li>
                                <li>å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</li>
                                <li>ç¶²è·¯é€£ç·šå•é¡Œ</li>
                            </ul>
                        </div>
                        <div class="grid grid-2" style="gap: 15px;">
                            <button class="btn btn-outline" onclick="location.reload()">ğŸ”„ é‡è©¦</button>
                            <button class="btn btn-primary" onclick="useDemoMode()">ğŸ“‹ ä½¿ç”¨ç¤ºç¯„æ¨¡å¼</button>
                        </div>
                    </div>
                `;
            }
        }

        // Step 1: HTTP ç™»å…¥å–å¾— token
        async function httpLogin(email, password) {
            const loginUrl = `${API_CONFIG.apiBase}/users/log_in`;
            
            const formData = new URLSearchParams();
            formData.append('user[email]', email);
            formData.append('user[password]', password);
            formData.append('locale', 'zh_TW');
            formData.append('key', API_CONFIG.key);
            formData.append('app_version', API_CONFIG.appVersion);
            
            try {
                const response = await fetch(loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData.toString()
                });
                
                const data = await response.json();
                
                if (data.status === 'ok' && data.data) {
                    return {
                        success: true,
                        userToken: data.data.user_token,
                        userId: data.data.user_id
                    };
                } else {
                    return {
                        success: false,
                        error: data.message || 'ç™»å…¥å¤±æ•—'
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    error: `HTTP è«‹æ±‚å¤±æ•—: ${error.message}`
                };
            }
        }

        // Step 2: WebSocket é€£æ¥
        async function connectWebSocket(userToken, userId) {
            return new Promise((resolve) => {
                try {
                    const wsUrl = `${API_CONFIG.wsBase}?userToken=${userToken}&locale=zh_TW&vsn=2.0.0`;
                    const ws = new WebSocket(wsUrl);
                    
                    const timeout = setTimeout(() => {
                        ws.close();
                        resolve({ success: false, error: 'WebSocket é€£æ¥é€¾æ™‚' });
                    }, API_CONFIG.timeout);
                    
                    ws.onopen = function() {
                        console.log('âœ… WebSocket å·²é€£ç·š');
                        
                        // ç™¼é€ phx_join åŠ å…¥é »é“
                        const joinMsg = ["6", "6", `player:${userId}`, "phx_join", {"fake": "ChannelPlayer", "fake2": 1}];
                        ws.send(JSON.stringify(joinMsg));
                        console.log('â¡ï¸ ç™¼é€ phx_join:', joinMsg);
                    };
                    
                    ws.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('â¬…ï¸ æ”¶åˆ°è¨Šæ¯:', data);
                            
                            // æª¢æŸ¥ phx_join å›æ‡‰
                            if (data[3] === 'phx_reply' && data[4]?.status === 'ok') {
                                clearTimeout(timeout);
                                wsConnection = ws;
                                currentPlayerId = userId;
                                resolve({
                                    success: true,
                                    playerId: userId
                                });
                            } else if (data[4]?.status === 'error') {
                                clearTimeout(timeout);
                                ws.close();
                                resolve({ success: false, error: data[4]?.response?.reason || 'Join å¤±æ•—' });
                            }
                        } catch (e) {
                            console.error('è§£æè¨Šæ¯å¤±æ•—:', e);
                        }
                    };
                    
                    ws.onerror = function(error) {
                        clearTimeout(timeout);
                        console.error('WebSocket éŒ¯èª¤:', error);
                        resolve({ success: false, error: 'WebSocket é€£æ¥å¤±æ•— (å¯èƒ½æ˜¯ CORS é™åˆ¶)' });
                    };
                    
                    ws.onclose = function() {
                        console.log('WebSocket å·²é—œé–‰');
                    };
                    
                } catch (error) {
                    resolve({ success: false, error: error.message });
                }
            });
        }

        // å˜—è©¦ç™»å…¥ï¼ˆæ•´åˆ HTTP + WebSocketï¼‰
        async function attemptLogin(email, password) {
            // Step 1: HTTP ç™»å…¥
            showLoadingState('æ­£åœ¨ç™»å…¥...');
            const loginResult = await httpLogin(email, password);
            
            if (!loginResult.success) {
                return loginResult;
            }
            
            console.log('âœ… HTTP ç™»å…¥æˆåŠŸ, token:', loginResult.userToken);
            console.log('âœ… user_id:', loginResult.userId);
            
            // Step 2: WebSocket é€£æ¥
            showLoadingState('æ­£åœ¨å»ºç«‹é€£ç·š...');
            const wsResult = await connectWebSocket(loginResult.userToken, loginResult.userId);
            
            return wsResult;
        }

        // ç™¼é€ API è«‹æ±‚ï¼ˆPhoenix æ ¼å¼: [join_ref, ref, topic, event, payload]ï¼‰
        let messageRef = 10;
        
        function sendApiRequest(event, payload = {}) {
            return new Promise((resolve, reject) => {
                if (!wsConnection || wsConnection.readyState !== WebSocket.OPEN) {
                    reject(new Error('WebSocket æœªé€£æ¥'));
                    return;
                }
                
                const ref = String(++messageRef);
                const topic = `player:${currentPlayerId}`;
                const msg = ["6", ref, topic, event, payload];
                
                console.log('â¡ï¸ ç™¼é€è«‹æ±‚:', msg);
                
                const timeout = setTimeout(() => {
                    wsConnection.removeEventListener('message', handler);
                    reject(new Error('è«‹æ±‚é€¾æ™‚'));
                }, 15000);
                
                const handler = function(e) {
                    try {
                        const data = JSON.parse(e.data);
                        // Phoenix æ ¼å¼å›æ‡‰: [join_ref, ref, topic, "phx_reply", {status, response}]
                        if (data[1] === ref && data[3] === 'phx_reply') {
                            clearTimeout(timeout);
                            wsConnection.removeEventListener('message', handler);
                            
                            if (data[4]?.status === 'ok') {
                                resolve(data[4]?.response || {});
                            } else {
                                reject(new Error(data[4]?.response?.reason || 'è«‹æ±‚å¤±æ•—'));
                            }
                        }
                    } catch (err) {
                        // ç¹¼çºŒç­‰å¾…
                    }
                };
                
                wsConnection.addEventListener('message', handler);
                wsConnection.send(JSON.stringify(msg));
            });
        }
        
        // å•Ÿå‹•å¿ƒè·³
        let heartbeatInterval = null;
        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            
            heartbeatInterval = setInterval(() => {
                if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {
                    const heartbeat = [null, String(++messageRef), "phoenix", "heartbeat", {}];
                    wsConnection.send(JSON.stringify(heartbeat));
                    console.log('â¤ï¸ å¿ƒè·³ç™¼é€');
                }
            }, 20000);
        }

        // æŸ¥è©¢æ‰€æœ‰è³‡æ–™
        async function fetchAllData() {
            // å•Ÿå‹•å¿ƒè·³
            startHeartbeat();
            
            showLoadingState('æ­£åœ¨æŸ¥è©¢è§’è‰²è³‡æ–™...');
            
            try {
                // æŸ¥è©¢è§’è‰²
                const actorsData = await sendApiRequest('actors', { body: '' });
                if (actorsData && actorsData.actors) {
                    ownedActors = actorsData.actors;
                    loadOwnedCharacters(ownedActors.map(a => ({
                        name: a.name,
                        level: a.level || 1,
                        scarcity: a.scarcity || 'N',
                        role: a.role || 'unknown',
                        equipped: a.weapon_prototype?.name || 'ç„¡'
                    })));
                }
            } catch (e) {
                console.error('è§’è‰²æŸ¥è©¢å¤±æ•—:', e);
            }
            
            showLoadingState('æ­£åœ¨æŸ¥è©¢åº«å­˜è³‡æ–™...');
            
            try {
                // æŸ¥è©¢èƒŒåŒ…
                const backpackData = await sendApiRequest('backpack', {});
                if (backpackData && backpackData.items) {
                    inventoryItems = backpackData.items;
                    loadInventory(inventoryItems.map(i => ({
                        name: i.name,
                        count: i.quantity || 1,
                        category: i.item_type || 'other'
                    })));
                }
            } catch (e) {
                console.error('åº«å­˜æŸ¥è©¢å¤±æ•—:', e);
            }
            
            showLoadingState('æ­£åœ¨æŸ¥è©¢ç¬¦æ–‡è³‡æ–™...');
            
            try {
                // æŸ¥è©¢ç¬¦æ–‡
                const runesResult = await sendApiRequest('weapon_prototypes', {});
                if (runesResult && runesResult.weapon_prototypes) {
                    runesData = runesResult.weapon_prototypes;
                    loadRunes(runesData.map(r => ({
                        name: r.name,
                        level: r.level || 1,
                        owner: r.actor_name || 'æœªè£å‚™',
                        stats: r.description || '-'
                    })));
                }
            } catch (e) {
                console.error('ç¬¦æ–‡æŸ¥è©¢å¤±æ•—:', e);
            }
            
            showLoadingState('æ­£åœ¨æŸ¥è©¢æŠ½çæ­·å²...');
            
            try {
                // æŸ¥è©¢æŠ½çæ­·å²
                const gachaResult = await sendApiRequest('used_recruit_coupons', {});
                if (gachaResult && gachaResult.records) {
                    gachaHistory = gachaResult.records;
                    loadGachaHistory(gachaHistory.map(g => ({
                        date: g.created_at?.split('T')[0] || '-',
                        result: g.actor_name || '-',
                        scarcity: g.scarcity || 'N',
                        pool: g.pool_name || '-'
                    })));
                }
            } catch (e) {
                console.error('æŠ½çæ­·å²æŸ¥è©¢å¤±æ•—:', e);
            }
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        function showLoadingState(message) {
            document.getElementById('loginSection').innerHTML = `
                <div class="card-body">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 15px;">${message}</p>
                    </div>
                </div>
            `;
        }

        // é¡¯ç¤ºå·²ç™»å…¥ç‹€æ…‹
        function showLoggedInState(info, isDemo) {
            document.getElementById('loginSection').innerHTML = `
                <div class="card-header">
                    <span class="card-title">${isDemo ? 'ğŸ“‹ ç¤ºç¯„æ¨¡å¼' : 'âœ… å·²ç™»å…¥'}</span>
                    <span class="badge ${isDemo ? 'badge-warning' : 'badge-success'}">${info}</span>
                </div>
                <div class="card-body">
                    <p>${isDemo ? 'ç›®å‰é¡¯ç¤ºçš„æ˜¯ç¯„ä¾‹è³‡æ–™ï¼Œéå¯¦éš›éŠæˆ²è³‡æ–™' : 'å·²æˆåŠŸé€£æ¥ä¸¦è¼‰å…¥æ‚¨çš„éŠæˆ²è³‡æ–™'}</p>
                    <button class="btn btn-outline" onclick="location.reload()">ğŸ”„ é‡æ–°æŸ¥è©¢</button>
                </div>
            `;
            
            // é¡¯ç¤ºæŸ¥è©¢çµæœåˆ†é 
            document.getElementById('queryTabs').style.display = 'block';
        }

        // è¼‰å…¥å·²æ“æœ‰è§’è‰²
        function loadOwnedCharacters(characters) {
            const container = document.getElementById('ownedCharacters');
            document.getElementById('ownedCount').textContent = `${characters.length} å€‹è§’è‰²`;
            
            container.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>è§’è‰²åç¨±</th>
                                <th>ç¨€æœ‰åº¦</th>
                                <th>ç­‰ç´š</th>
                                <th>è·æ¥­</th>
                                <th>è£å‚™ç¬¦æ–‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${characters.map(char => `
                                <tr>
                                    <td><strong>${char.name}</strong></td>
                                    <td><span class="badge scarcity-${char.scarcity}">${char.scarcity}</span></td>
                                    <td>Lv.${char.level}</td>
                                    <td>${getRoleName(char.role)}</td>
                                    <td>${char.equipped}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // è¼‰å…¥åº«å­˜
        let currentInventory = [];
        function loadInventory(items) {
            currentInventory = items;
            renderInventory(items);
        }

        function renderInventory(items) {
            const container = document.getElementById('inventoryList');
            
            container.innerHTML = `
                <div class="grid grid-auto">
                    ${items.map(item => `
                        <div class="card" style="margin-bottom: 10px;">
                            <div class="card-body" style="padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span><strong>${item.name}</strong></span>
                                    <span class="badge badge-primary">x${item.count.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function filterInventory(category) {
            let filtered = currentInventory;
            if (category !== 'all') {
                filtered = currentInventory.filter(item => item.category === category);
            }
            renderInventory(filtered);
        }

        // è¼‰å…¥ç¬¦æ–‡
        function loadRunes(runes) {
            const container = document.getElementById('runesList');
            
            container.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ç¬¦æ–‡åç¨±</th>
                                <th>ç­‰ç´š</th>
                                <th>è£å‚™è€…</th>
                                <th>å±¬æ€§åŠ æˆ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${runes.map(rune => `
                                <tr>
                                    <td><strong>${rune.name}</strong></td>
                                    <td>Lv.${rune.level}</td>
                                    <td>${rune.owner}</td>
                                    <td>${rune.stats}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // è¼‰å…¥æŠ½çæ­·å²
        function loadGachaHistory(records) {
            const container = document.getElementById('gachaHistory');
            
            // è¨ˆç®—çµ±è¨ˆ
            const total = records.length;
            const rCount = records.filter(g => g.scarcity === 'R').length;
            const srCount = records.filter(g => g.scarcity === 'SR').length;
            const ssrCount = records.filter(g => g.scarcity === 'SSR').length;
            
            document.getElementById('totalGacha').textContent = total;
            document.getElementById('rRate').textContent = total > 0 ? ((rCount / total) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('srRate').textContent = total > 0 ? ((srCount / total) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('ssrRate').textContent = total > 0 ? ((ssrCount / total) * 100).toFixed(1) + '%' : '0%';
            
            container.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>æŠ½çæ± </th>
                                <th>ç²å¾—è§’è‰²</th>
                                <th>ç¨€æœ‰åº¦</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${records.map(record => `
                                <tr>
                                    <td>${record.date}</td>
                                    <td>${record.pool}</td>
                                    <td><strong>${record.result}</strong></td>
                                    <td><span class="badge scarcity-${record.scarcity}">${record.scarcity}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    </script>
</body>
</html>
